// Generated by delombok at Thu Jul 04 12:27:09 CEST 2024
package no.nav.melosys.eessi.security;

import java.util.Map;

import com.nimbusds.jwt.SignedJWT;
import no.nav.security.token.support.core.context.TokenValidationContext;
import no.nav.security.token.support.core.jwt.JwtToken;
import no.nav.security.token.support.spring.SpringTokenValidationContextHolder;
import org.springframework.web.context.request.RequestContextHolder;

final class ContextHolder {
    @java.lang.SuppressWarnings("all")
    private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(ContextHolder.class);
    private final SpringTokenValidationContextHolder context;
    private static ContextHolder instans;
    private static final String AAD = "aad";
    private static final String IDTYP = "idtyp";
    private static final String APP = "app";

    private ContextHolder(SpringTokenValidationContextHolder context) {
        this.context = context;
    }

    public ContextHolder() {
        this.context = new SpringTokenValidationContextHolder();
    }

    static ContextHolder getInstance() {
        if (instans == null) {
            instans = new ContextHolder(new SpringTokenValidationContextHolder());
        }
        return instans;
    }

        boolean canExchangeOBOToken() {
        // Sjekk om vi skal bruke systemtoken basert på thread-local kontekst
        if (ThreadLocalAccessInfo.Companion.skalBrukeSystemToken()) {
            return false;
        }
        
        TokenValidationContext tokenValidationContext = getTokenContext();
        if (tokenValidationContext != null) {
            JwtToken jwtToken = tokenValidationContext.getJwtToken(AAD);
            return (jwtToken != null && !aktørErApplikasjon(jwtToken));
        }
        return false;
    }

    // Token har allerede blitt validert
    boolean aktørErApplikasjon(JwtToken jwtToken) {
        try {
            SignedJWT jwt = SignedJWT.parse(jwtToken.getTokenAsString());
            Map<String, Object> payload = jwt.getPayload().toJSONObject();
            return payload.containsKey(IDTYP) && payload.get(IDTYP).equals(APP);
        } catch (final java.lang.Throwable $ex) {
            throw lombok.Lombok.sneakyThrow($ex);
        }
    }

    public TokenValidationContext getTokenContext() {
        if (RequestContextHolder.getRequestAttributes() != null && context.getTokenValidationContext().hasTokenFor(AAD)) {
            return context.getTokenValidationContext();
        }
        return null;
    }
}
