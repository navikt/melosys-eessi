// Generated by delombok at Thu Jul 04 12:27:09 CEST 2024
package no.nav.melosys.eessi.identifisering;

import java.util.Optional;
import no.nav.melosys.eessi.identifisering.event.BucIdentifisertEvent;
import no.nav.melosys.eessi.integration.PersonFasade;
import no.nav.melosys.eessi.models.BucIdentifisert;
import no.nav.melosys.eessi.repository.BucIdentifisertRepository;
import no.nav.melosys.eessi.service.saksrelasjon.SaksrelasjonService;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.dao.IncorrectResultSizeDataAccessException;
import org.springframework.stereotype.Service;

@Service
public class BucIdentifisertService {
    @java.lang.SuppressWarnings("all")
    private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(BucIdentifisertService.class);
    private final BucIdentifisertRepository bucIdentifisertRepository;
    private final SaksrelasjonService saksrelasjonService;
    private final PersonFasade personFasade;
    private final ApplicationEventPublisher applicationEventPublisher;

    public BucIdentifisertService(BucIdentifisertRepository bucIdentifisertRepository, SaksrelasjonService saksrelasjonService, PersonFasade personFasade, ApplicationEventPublisher applicationEventPublisher) {
        this.bucIdentifisertRepository = bucIdentifisertRepository;
        this.saksrelasjonService = saksrelasjonService;
        this.personFasade = personFasade;
        this.applicationEventPublisher = applicationEventPublisher;
    }

    /**
     * Henter ident fra saksrelasjon, eller fra buc_identifisert tabell om førstnevnte ikke finnes (vil oppstå for saker eldre enn tabellen)
     */
    public Optional<String> finnIdentifisertPerson(String rinaSaksnummer) {
        var ident = saksrelasjonService.finnAktørIDTilhørendeRinasak(rinaSaksnummer).map(personFasade::hentNorskIdent);
        if (ident.isPresent()) {
            return ident;
        }
        return bucIdentifisertRepository.findByRinaSaksnummer(rinaSaksnummer).map(BucIdentifisert::getFolkeregisterident);
    }

    public void lagreIdentifisertPerson(String rinaSaksnummer, String ident) {
        try {
            bucIdentifisertRepository.findByRinaSaksnummer(rinaSaksnummer).ifPresentOrElse(i -> log.info("Rinasak {} allerede identifisert", rinaSaksnummer), () -> bucIdentifisertRepository.save(new BucIdentifisert(null, rinaSaksnummer, ident)));
            applicationEventPublisher.publishEvent(new BucIdentifisertEvent(rinaSaksnummer, ident));
        } catch (IncorrectResultSizeDataAccessException e) {
            log.error("Duplikat resultat ved oppslag av ident for rinaSak {}", rinaSaksnummer, e);
            throw e;
        }
    }
}
